# Godot 4 テトリス 仕様書

## 1. ドキュメント情報
- ドキュメント名: Godot 4 テトリス仕様書
- 対象エンジン: Godot 4.2 以上
- 対象プラットフォーム: Windows / macOS / Linux（デスクトップ）
- 優先入力: キーボード（将来的にゲームパッド対応）

## 2. 目的
本仕様書は、Godot 4 環境で開発するテトリスゲームの実装基準を定義する。
実装者が同一の挙動・品質で開発できるよう、ゲームルール、シーン構成、スクリプト責務、データ仕様、UI/UX、テスト観点を明確化する。

## 3. ゲーム概要
- ジャンル: 落ち物パズル
- ルール基準: Tetris Guideline を参考にした標準ルール
- 主な機能:
  - 10x20 のプレイフィールド（上部に隠し行 2 行）
  - 7-Bag 方式のミノ生成
  - ホールド機能
  - ゴースト表示
  - スーパーローテーションシステム（SRS）
  - ハードドロップ / ソフトドロップ
  - スコア / レベル / ライン数管理
  - ゲームオーバー判定

## 4. 画面仕様

### 4.1 画面一覧
1. タイトル画面
2. ゲーム画面
3. ポーズメニュー
4. リザルト画面

### 4.2 タイトル画面
- 表示要素:
  - ゲームタイトル
  - 「Start」ボタン
  - 「Options」ボタン（任意）
  - 「Quit」ボタン
- 操作:
  - Enter / Space: Start
  - Esc: Quit（プラットフォーム依存で無効可）

### 4.3 ゲーム画面
- 左側: ホールド枠
- 中央: プレイフィールド（10x20 + hidden 2 rows）
- 右側: Next ミノ表示（最低 5 個）
- 上部または下部:
  - Score
  - Level
  - Lines
  - Time（任意）

### 4.4 ポーズメニュー
- 表示項目:
  - Resume
  - Restart
  - Back to Title
- 操作:
  - Esc: ポーズ ON/OFF

### 4.5 リザルト画面
- 表示項目:
  - 最終スコア
  - 到達レベル
  - 消去ライン数
  - プレイ時間
  - 「Retry」「Titleへ戻る」

## 5. コアルール仕様

### 5.1 フィールド仕様
- 論理サイズ: 幅10、高さ22（うち可視20、隠し2）
- 座標系:
  - 左上原点
  - X: 0〜9
  - Y: 0〜21（0,1 は hidden row）
- ブロックサイズ: 1 セル単位（描画時にピクセルへ変換）

### 5.2 テトロミノ定義
- 種類: I, O, T, S, Z, J, L
- 各ミノは4ブロックで構成
- 回転状態: 0, R, 2, L の4状態
- 色はミノごとに固定

### 5.3 生成方式（Randomizer）
- 7-Bag 方式を採用
  - 7種を1セットにしてシャッフル
  - Bag が空になったら新しい Bag を生成
- Next Queue は最低 5 個以上維持

### 5.4 スポーン仕様
- 生成位置:
  - フィールド上部中央付近
  - ミノごとに既定の初期オフセットを持つ
- スポーン時に既存ブロックと衝突する場合、ゲームオーバー

### 5.5 落下仕様
- 自動落下（Gravity）:
  - レベルに応じて落下間隔を短縮
- ソフトドロップ:
  - 押下中は重力を加速
  - スコア加点あり
- ハードドロップ:
  - 着地位置まで瞬時に移動
  - 1セルごとの移動距離に応じて加点
  - 実行後ただちに固定

### 5.6 移動仕様
- 左右移動: 1セルずつ
- 横移動連打対応:
  - DAS（Delayed Auto Shift）
  - ARR（Auto Repeat Rate）
- 壁・既存ブロックと衝突する移動は無効

### 5.7 回転仕様
- 回転方向:
  - 右回転（CW）
  - 左回転（CCW）
  - 180度回転（任意実装）
- SRS（Super Rotation System）による Wall Kick を適用
- I ミノとそれ以外で Kick テーブルを分離

### 5.8 接地と固定
- 接地判定:
  - 現在ミノが1セル下に移動不可で接地とみなす
- 固定遅延（Lock Delay）:
  - 接地後、一定時間は移動/回転で固定を遅延可能
  - 最大延長回数上限を設定（例: 15 回）
- 固定時:
  - フィールドへブロック反映
  - ライン消去判定へ遷移

### 5.9 ライン消去
- 横1列がすべて埋まると消去
- 同時消去数: 1〜4 ライン（Tetris は 4 ライン消去）
- 消去後、上部ブロックを落下

### 5.10 T-Spin 判定（推奨）
- T ミノ回転直後かつ特定コーナー占有条件で T-Spin を判定
- 判定種別:
  - T-Spin Mini
  - T-Spin Single/Double/Triple
- 実装簡略化として初期版では無効化しても良い（将来拡張ポイントとして構造は確保）

### 5.11 Back-to-Back / Combo
- Back-to-Back:
  - Tetris または T-Spin 系連続時にボーナス
- Combo:
  - 連続でライン消去が発生した回数に応じて加点

### 5.12 ホールド
- Hold スロットは 1 つ
- 1 回のミノターン中に Hold できるのは 1 回まで
- Hold 実行:
  - 未保持なら現在ミノを保存し、Next から新規生成
  - 保持済みなら現在ミノと交換
- 交換後ミノは初期姿勢・初期位置で出現

### 5.13 ゴースト
- 現在ミノの落下到達位置を半透明で表示
- 操作ミノと同じ形状・回転状態

### 5.14 ゲームオーバー
- 以下のいずれかで発生:
  1. 新規スポーン時に衝突
  2. 固定ブロックが可視領域上端を超える（運用で採用する場合）

## 6. スコア・レベル仕様（初期案）

### 6.1 基本スコア（ライン消去）
- Single: 100 x Level
- Double: 300 x Level
- Triple: 500 x Level
- Tetris: 800 x Level

### 6.2 ボーナス
- Soft Drop: +1 / セル
- Hard Drop: +2 / セル
- Back-to-Back Tetris: 1.5 倍
- Combo: `50 x ComboCount x Level`（例）

### 6.3 レベルアップ
- 目安: 10 ラインごとに Level +1
- Level 上昇で重力速度増加

### 6.4 落下速度テーブル
- 実装方式 A: レベルごとの固定秒数テーブル
- 実装方式 B: `gravity = base * pow(rate, level)`
- 初期は A を推奨（デバッグ容易）

## 7. 入力仕様（Godot Input Map）

推奨アクション名:
- `move_left`
- `move_right`
- `soft_drop`
- `hard_drop`
- `rotate_cw`
- `rotate_ccw`
- `rotate_180`（任意）
- `hold`
- `pause`
- `ui_accept`
- `ui_cancel`

推奨デフォルトキー:
- Left / Right
- Down（soft drop）
- Space（hard drop）
- X（CW）
- Z（CCW）
- A（180）
- C / Shift（hold）
- Esc（pause）

## 8. シーン構成（Godot 4）

### 8.1 想定ディレクトリ
- `scenes/`
  - `Main.tscn`
  - `Title.tscn`
  - `Game.tscn`
  - `Result.tscn`
  - `ui/`
  - `pieces/`
- `scripts/`
  - `game_manager.gd`
  - `board.gd`
  - `piece.gd`
  - `randomizer.gd`
  - `scoring.gd`
  - `input_buffer.gd`
- `resources/`
  - `piece_data/`
  - `theme/`

### 8.2 主要ノード
- `Game` (Node2D or Control)
  - `Board` (Node2D)
  - `ActivePieceLayer` (Node2D)
  - `GhostLayer` (Node2D)
  - `UILayer` (CanvasLayer)
  - `PauseLayer` (CanvasLayer)

### 8.3 スクリプト責務
- `game_manager.gd`
  - ゲーム状態管理（Playing / Paused / Result）
  - 各システムの更新順制御
- `board.gd`
  - グリッド管理
  - 衝突判定
  - ライン消去
- `piece.gd`
  - 現在ミノの座標・回転状態
  - 移動/回転処理
- `randomizer.gd`
  - 7-Bag 生成と Next Queue 管理
- `scoring.gd`
  - スコア計算・コンボ・B2B
- `input_buffer.gd`
  - 入力バッファ / DAS / ARR

## 9. データ設計

### 9.1 ボードデータ
- 型: 2次元配列 `Array[Array[int]]` または `PackedInt32Array`
- 値:
  - `-1`: 空
  - `0..6`: ミノ種別ID

### 9.2 ミノ形状データ
- `Resource` または `Dictionary` として管理
- 各ミノ定義:
  - 種別ID
  - 回転ごとのローカル座標配列（4セル）
  - 色
  - SRS Kick テーブル参照

### 9.3 セーブデータ（任意）
- 保存対象:
  - ハイスコア
  - 設定（キーコンフィグ、音量）
- 保存方法:
  - `user://save_data.cfg`（ConfigFile）

## 10. 更新ループ仕様

### 10.1 フレーム更新順
1. 入力取得
2. 横移動 / 回転処理
3. 重力処理
4. 接地・固定判定
5. ライン消去
6. スコア・レベル更新
7. スポーン
8. 描画更新

### 10.2 時間管理
- `_process(delta)` ではなく `_physics_process(delta)` 基準を推奨
- 内部タイマーで重力・DAS・ARR・Lock Delay を管理

## 11. UI/UX ガイド
- 文字は視認性の高いフォントを使用
- 色覚多様性を考慮し、ミノ色は明度差も確保
- 演出:
  - ライン消去エフェクト（短時間）
  - ハードドロップ時の着地演出
- 音:
  - 移動
  - 回転
  - 固定
  - ライン消去
  - ゲームオーバー

## 12. 実装フェーズ

### Phase 1（MVP）
- ボード表示
- 7種ミノスポーン
- 移動 / 回転 / 接地 / 固定
- ライン消去
- ゲームオーバー

### Phase 2
- スコア / レベル
- Next / Hold / Ghost
- ポーズ / リザルト

### Phase 3
- T-Spin / B2B / Combo 完全対応
- 演出・SE・BGM
- 設定画面

## 13. テスト観点
- 衝突判定（左右・下・回転）
- SRS Kick 成功/失敗パターン
- ライン消去整合性（1〜4ライン）
- Hold 制限（1ターン1回）
- Bag 偏り検証（長期試行）
- ロック遅延の上限動作
- ゲームオーバー境界ケース
- スコア計算の単体テスト

## 14. 非機能要件
- 目標FPS: 60
- 入力遅延を最小化（体感優先）
- 主要ロジックはフレームレート非依存
- コードは責務分離し、将来的な対戦/AI拡張を考慮

## 15. 将来拡張案
- キーコンフィグ UI
- リプレイ保存
- ゴーストON/OFF設定
- マラソン以外のモード（Sprint, Ultra）
- AI対戦・お邪魔行システム

---
本仕様書は初版であり、実装進行に合わせて随時更新する。
