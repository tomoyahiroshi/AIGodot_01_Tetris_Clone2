# テトリスゲーム仕様書（Godot 4）

## 1. 目的
本仕様書は、Godot 4 を用いて開発するシングルプレイのテトリスゲームについて、機能要件・非機能要件・データ構造・シーン設計・実装方針を定義する。

## 2. 対象プラットフォーム
- 対応エンジン: Godot Engine 4.x
- 対応プラットフォーム: PC（Windows / macOS / Linux）
- 入力デバイス: キーボード

## 3. ゲーム概要
- 10 列 × 20 行のプレイフィールドにテトロミノが上から落下する。
- プレイヤーはテトロミノを左右移動・回転・高速落下させ、横一列を揃えて消去する。
- ライン消去でスコアを獲得し、レベル上昇に伴い落下速度が増加する。
- ブロックが初期スポーン位置で固定できない状態になるとゲームオーバー。

## 4. 画面仕様

### 4.1 メインゲーム画面
表示要素:
- プレイフィールド（10×20）
- 現在スコア
- 現在レベル
- 累計消去ライン数
- 次のテトロミノ（Next）プレビュー
- ホールド枠（Hold）
- 一時停止表示（Pause）
- ゲームオーバー表示（Game Over）

### 4.2 UI 挙動
- ゲーム開始時は「Ready」演出なしで即開始。
- 一時停止中は落下・入力（再開操作を除く）を停止。
- ゲームオーバー時にリトライ操作を受け付ける。

## 5. テトロミノ仕様

### 5.1 種類
7 種類（I, O, T, S, Z, J, L）を実装する。

### 5.2 生成ルール
- 7-bag 方式を採用する（7 種をシャッフルして使い切る）。
- bag が空になったら新しい 7 種セットを補充する。

### 5.3 スポーン位置
- 基本スポーン座標はフィールド上端中央付近。
- 各ミノのローカル形状に合わせて初期オフセットを調整する。
- スポーン時に衝突済みで移動不可の場合はゲームオーバー。

### 5.4 回転仕様
- Super Rotation System（SRS）準拠の壁蹴りを使用。
- 回転方向: 時計回り（CW）/反時計回り（CCW）。
- 180 度回転は初期バージョンでは未対応（拡張余地として設計）。

## 6. 操作仕様（デフォルト）
- 左移動: Left Arrow
- 右移動: Right Arrow
- ソフトドロップ: Down Arrow
- ハードドロップ: Space
- 左回転（CCW）: Z
- 右回転（CW）: X
- ホールド: C
- 一時停止: Esc
- リトライ（ゲームオーバー時）: Enter

備考:
- Godot Input Map に同等アクション名を定義し、キー差し替え可能な設計にする。

## 7. ゲームルール

### 7.1 落下
- 一定フレームまたは秒間隔で 1 マス自然落下。
- ソフトドロップ中は自然落下より高い速度で落下。
- ハードドロップは着地位置まで瞬時に移動し、即固定。

### 7.2 接地と固定
- ミノが床または既存ブロックに接地すると Lock Delay を開始。
- Lock Delay 中に移動/回転した場合、規定回数まで固定猶予をリセット可能。
- 猶予時間経過またはリセット上限到達で固定。

### 7.3 ライン消去
- 固定後に完成した横一列を同時消去。
- 同時消去数は 1～4 ライン（Tetris は 4 ライン）。

### 7.4 ホールド
- 現在ミノをホールド枠に退避し、ホールド枠のミノを出す。
- 1 回の落下サイクル（スポーンから固定まで）でホールドは 1 回のみ。
- 初回ホールド時、次ミノをスポーンする。

### 7.5 ゴースト
- 現在ミノの最終落下地点（ゴースト）を半透明表示する。

### 7.6 ゲームオーバー
- スポーン時に配置不能な場合、ゲーム終了。

## 8. スコア・レベル仕様

### 8.1 基本スコア（例）
- 1 ライン: 100 × レベル
- 2 ライン: 300 × レベル
- 3 ライン: 500 × レベル
- 4 ライン: 800 × レベル

### 8.2 ドロップ加点
- ソフトドロップ: 1 マスあたり +1
- ハードドロップ: 1 マスあたり +2

### 8.3 レベルアップ
- 10 ライン消去ごとにレベル +1。
- レベル上昇に応じて自然落下間隔を短縮。

### 8.4 落下速度テーブル
- `fall_interval = max(0.05, 0.8 - (level - 1) * 0.07)` 秒（初期案）。
- バランス調整しやすいよう定数化して管理する。

## 9. シーン構成（Godot）

### 9.1 主要シーン
- `Main.tscn`: エントリーポイント
- `Game.tscn`: ゲーム本体（盤面・ロジック管理）
- `UI.tscn`: スコア、レベル、Next/Hold、状態表示
- `Tetromino.tscn`: 1 ミノの見た目と制御
- `Cell.tscn`（任意）: 1 マス描画の共通化

### 9.2 ノード設計方針
- `Game` ノードがゲーム状態（盤面配列・現在ミノ・次ミノキュー・スコア）を一元管理。
- UI はシグナル購読で状態表示のみ行い、ゲームロジックを持たない。
- テトロミノ形状データは `Resource` または定数 Dictionary で管理。

## 10. データ構造

### 10.1 盤面
- 2 次元配列 `board[height][width]`。
- 空セル: `-1`、占有セル: ミノ種別 ID（0～6）を格納。

### 10.2 ミノ定義
- 各ミノに対し回転状態（0, R, 2, L）の座標配列を保持。
- 色情報（Color）と表示用 ID を紐づける。

### 10.3 ゲーム状態
- `current_piece`, `hold_piece`, `next_queue`。
- `score`, `level`, `lines_cleared`, `is_paused`, `is_game_over`。
- ロック遅延用に `lock_timer`, `lock_reset_count` を保持。

## 11. 入力処理
- 入力は `_unhandled_input` または `_process` でアクションベースに処理。
- 左右移動は DAS/ARR を導入可能な構造にする（初版は単発入力でも可）。
- 一時停止中は再開・終了系以外の入力を無効化。

## 12. シグナル設計
- `score_changed(score: int)`
- `level_changed(level: int)`
- `lines_changed(lines: int)`
- `next_updated(queue: Array)`
- `hold_updated(piece_type: int)`
- `game_over(final_score: int)`

UI 更新は上記シグナルで疎結合に行う。

## 13. 非機能要件
- 60 FPS 環境で違和感ない入力応答。
- ロジック更新はフレームレート非依存（delta ベース）で実装。
- 主要ロジックは関数分離し、将来の自動テスト追加を容易にする。
- 可読性重視（命名統一、定数集約、コメント最小限だが要点明記）。

## 14. 保存・設定
- ハイスコアを `user://save_game.json` に保存。
- 保存項目: `high_score`。
- 起動時ロード、ゲーム終了時または更新時にセーブ。

## 15. 開発マイルストーン
1. 盤面・ミノ落下・固定・ライン消去のコア実装
2. Next / Hold / Ghost / UI 実装
3. スコア・レベル・速度調整
4. 一時停止・ゲームオーバー・リトライ
5. セーブ機能・調整・デバッグ

## 16. 受け入れ条件
- 7 種すべてのミノが正しく出現し、回転・移動できる。
- ライン消去とスコア加算が仕様通り動作する。
- レベル上昇で落下速度が上がる。
- ホールドが 1 サイクル 1 回制限で機能する。
- スポーン不能時にゲームオーバーになる。
- リトライでゲーム状態が初期化される。

## 17. 将来拡張（任意）
- T-Spin 判定とボーナス
- Back-to-Back / Ren（Combo）
- キーコンフィグ画面
- 効果音・BGM・演出強化
- モバイル入力対応
